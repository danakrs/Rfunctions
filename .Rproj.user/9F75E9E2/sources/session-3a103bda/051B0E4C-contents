---
title: "RNASeq Report File 1"
author: "Dana Krauss"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
    workflowr::wflow_html:
        code_folding: hide
        df_print: paged
        toc: true
        toc_float: true
        toc_depth: 5
        theme:
          bootswatch: "flatly"
          primary: "#2C3E50"
          secondary: "#1B9E77"
          text-primary: "#D0006F"
          text-secondary: "#D0006F"
params: 
  project: "RNASeq_Gregor_2025_combined"   
  project_dir: !r c("/srv/home/dkrauss/RProjects") 
  user_dir: !r c("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025") 
  script_number: !r c("01-")
  count_matrix: "/Mikulits_8samples_raw_gene_counts_Ser213_GeneSymbols_GeneTypes.tsv"
  sampleAnnotation: "/Mikulits_16samples_20250124_Metadata_Overview.csv" 
  condition: "group"
  #covariate: "batch"
  exclude: !r c(NULL)
  level: !r c("WT", "MUT")
  contrast: !r list(Ser213_MUT_vs_WT = c("group", "MUT","WT"))
  res_option: "ihw+shrink" #c("lfc_shrink") #c("ihw+shrink")
  fdr_cutoff: 0.1
  fc_cutoff: 1
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---


# Initialization



```{r libraries, message=FALSE, warning=FALSE, cache=FALSE, include=TRUE}
knitr::opts_chunk$set(
 fig.width = 6,
 fig.asp = 0.8,
 out.width = "80%"
)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
# load required libraries
library("knitr")
library("tidyverse")
library("ggplot2")
library("org.Hs.eg.db") 
library(DESeq2)
library(ComplexHeatmap)
library(writexl)
library(clusterProfiler)
  
### pull variables from params into environment
script_number <- params$script_number
project <- params$project
tag <- paste0(script_number,project)

user_dir <- params$user_dir
project_dir <- params$project_dir
plots_dir <- paste0(user_dir,"/plots")
results_dir <- paste0(user_dir,"/results")
scripts_dir <- paste0(user_dir,"/scripts")
functions_dir <- paste0("/srv/home/dkrauss/RProjects/generalFiles/functions")
data_dir <- paste0(user_dir,"/data")


condition <- params$condition
covariate <- params$covariate
sampleAnnotation <- params$sampleAnnotation
contrasts <- params$contrast
level = params$level
exclude <- params$exclude
res_option <-  params$res_option 
fdr_cutoff <-  params$fdr_cutoff 
fc_cutoff <-  params$fc_cutoff 



if (is.null(covariate)) {
  design_formula <- as.formula(paste0("~ ", condition))
} else {
  design_formula <- as.formula(paste0("~ ", covariate, " + ", condition))
}


## read in all functions in functions_dir
file_list <- list.files(path=file.path(functions_dir), pattern=".R",full.names=TRUE) 
for (x in 1:length(file_list)){
  source(file_list[x])
}


col_sel <- get_colors()
anno_colors <- list(Status = c(WT = "#F0546A", MUT = "#7CB6E9"))
my_palette <- colorRampPalette(c("#F0546A", "white","#7CB6E9"))(100)
my_palette_1 <- colorRampPalette(c("#007AFF", "white", "#FF3B30"))(100)


gene_id_type = "SYMBOL" #for mapping

set.seed(1414)
```


------------------------------------------------------------------------


# 0 - Load Data 

## Comparisons {.tabset .tabset-pills}

### 0.1 - stimulated data

```{r, message=F, warning=F}

# Load count matrix
count_data <- read.table(file.path(data_dir,params$count_matrix), header = TRUE, sep = "\t")

# Optional: rename columns for clarity
colnames(count_data)[1:3] <- c("GeneType", "GeneSymbol","GeneID")

# Extract and format count matrix
gene_info    <- count_data[, 1:3]
count_matrix <- as.matrix(count_data[, -(1:3)])
rownames(count_matrix) <- gene_info$GeneID
storage.mode(count_matrix) <- "integer"

# Check for NA or negative counts
if (any(is.na(count_matrix)) || any(count_matrix < 0)) {
  stop("Invalid values (NA or negative) detected in count matrix.")
}


# Define logical filters
is_protein_coding <- gene_info$GeneType == "protein_coding"
is_mito_ribo <- grepl("^MT-", gene_info$GeneSymbol) |
  gene_info$GeneType %in% c("Mt_rRNA", "Mt_tRNA", "rRNA", "ribosomal")

# Combine filters
filter_protein_only <- is_protein_coding & !is_mito_ribo
table(filter_protein_only)  # count how many retained

# Apply filtering
count_matrix <- count_matrix[filter_protein_only, ]
gene_info    <- gene_info[filter_protein_only, ]

# Report
message("Retained ", nrow(count_matrix), " protein-coding genes after MT/ribo removal.")

# Clean up
rm(filter_protein_only, is_protein_coding, is_mito_ribo)


```
Load Metadata
```{r,message=F, warning=F}
# Load metadata (assumes 8 samples in top rows)
meta_raw <- read.csv(
  file.path(data_dir,paste0("Mikulits_16samples_20250124_Metadata_Overview.csv")),
  header      = TRUE,
  sep         = ",",
  nrows       = 8,
  strip.white = TRUE,
  check.names = FALSE
)

# Format metadata
meta_data <- meta_raw %>%
  mutate(
    Ser213_status = if_else(grepl("Ser213", sampleName), "MUT", "WT"),
    replicate     = factor(rep(1:4, 2)),
    batch         = replicate
  ) %>%
  dplyr::select(sampleID, Ser213_status, replicate, batch)


# Match metadata to count matrix
missing_meta <- setdiff(colnames(count_matrix), meta_data$sampleID)
if (length(missing_meta)) {
  stop("No metadata for the following sample IDs: ", paste(missing_meta, collapse = ", "))
}

sample_info <- meta_data[match(colnames(count_matrix), meta_data$sampleID), ]
rownames(sample_info) <- sample_info$sampleID

if (!all(rownames(sample_info) == colnames(count_matrix))) {
  stop("Metadata and count matrix are misaligned!")
}

# Factorise metadata and verify status assignment
sample_info <- sample_info %>%
  mutate(
    Ser213_status = factor(Ser213_status, levels = c("WT", "MUT")),
    replicate     = factor(replicate),
    batch         = factor(batch)
  ) %>%
  mutate(
    sample_ID = sampleID,
    group = Ser213_status,
    condition = c("stimulated")
  )

table(sample_info$Ser213_status)

```


```{r, eval = T, include = T, message=FALSE, warning=FALSE}
# --- Handle Duplicate Ensembl IDs ---

# Remove Ensembl version numbers (e.g. ENSG00000123456.1 → ENSG00000123456)
# This ensures compatibility with annotations and collapsing
if (!"GeneID" %in% colnames(gene_info)) stop("Column 'GeneID' not found in gene_info.")
gene_info$ensembl_id <- sub("\\..*$", "", gene_info$GeneID)
rownames(count_matrix) <- gene_info$ensembl_id

# Collapse duplicate Ensembl IDs by keeping the row with the highest library-size total
dup_id <- duplicated(rownames(count_matrix))
table(dup_id)  # view how many duplicates found                                                - 45 duplicates found

if (any(dup_id)) {
  message("Found ", sum(dup_id), " duplicate Ensembl IDs – collapsing to one row each")
  
  # Compute per-gene library size across all samples
  libsize_vec <- rowSums(count_matrix)
  gene_info$libsize <- libsize_vec
  
  # Collapse count matrix using rownames as group                                               - groups by row name and sums the counts
  count_matrix <- rowsum(count_matrix, group = rownames(count_matrix))
  
  # Keep annotation row with highest expression for each gene
  gene_info_unique <- gene_info %>%
    dplyr::group_by(ensembl_id) %>%
    dplyr::slice_max(order_by = libsize, n = 1, with_ties = FALSE) %>%
    dplyr::ungroup() %>%
    dplyr::select(-libsize)
  
  # Align annotation with collapsed count matrix
  gene_info <- gene_info_unique[match(rownames(count_matrix), gene_info_unique$ensembl_id), ]
}

# Consistency check
stopifnot(identical(rownames(count_matrix), gene_info$ensembl_id))

rm(dup_id)

# We have now removed duplicates and ensured consistency between count_matrix and gene_info



# --- Filter by Minimum Expression Threshold (Library Size) ---

# Filter out genes with low expression across all samples
# Retain genes ≥10 counts in ≥4 samples [fits for our 4x2 = 8 libraries]
min_count <- 10
min_samples <- 4

expressed <- rowSums(count_matrix >= min_count) >= min_samples
count_matrix <- count_matrix[expressed, ]
gene_info    <- gene_info[expressed, ]

message("Retained ", nrow(count_matrix),
        " genes after filtering by minimum expression (",
        min_count, " counts in at least ", min_samples, " samples)")

rm(expressed)


## by Dana - change to SYMBOL ID here

# --- Handle Duplicate SYMBOL IDs ---


rownames(count_matrix) <- gene_info$GeneSymbol

# Collapse duplicate SYMBOL IDs by keeping the row with the highest library-size total
dup_id <- duplicated(rownames(count_matrix))
table(dup_id)  # view how many duplicates found                                                - 9 duplicates found

if (any(dup_id)) {
  message("Found ", sum(dup_id), " duplicate SYMBOL IDs – collapsing to one row each")
  
  # Compute per-gene library size across all samples
  libsize_vec <- rowSums(count_matrix)
  gene_info$libsize <- libsize_vec
  
  # Collapse count matrix using rownames as group                                               - groups by row name and sums the counts
  count_matrix <- rowsum(count_matrix, group = rownames(count_matrix))
  
  # Keep annotation row with highest expression for each gene
  gene_info_unique <- gene_info %>%
    dplyr::group_by(GeneSymbol) %>%
    dplyr::slice_max(order_by = libsize, n = 1, with_ties = FALSE) %>%
    dplyr::ungroup() %>%
    dplyr::select(-libsize)
  
  # Align annotation with collapsed count matrix
  gene_info <- gene_info_unique[match(rownames(count_matrix), gene_info_unique$GeneSymbol), ]
}

# Consistency check
stopifnot(identical(rownames(count_matrix), gene_info$GeneSymbol))

rm(dup_id)

# We have now removed duplicates and ensured consistency between count_matrix and gene_info



# --- Filter by Minimum Expression Threshold (Library Size) ---

# Filter out genes with low expression across all samples
# Retain genes ≥10 counts in ≥4 samples [fits for our 4x2 = 8 libraries]
min_count <- 10
min_samples <- 4

expressed <- rowSums(count_matrix >= min_count) >= min_samples
count_matrix <- count_matrix[expressed, ]
gene_info    <- gene_info[expressed, ]

message("Retained ", nrow(count_matrix),
        " genes after filtering by minimum expression (",
        min_count, " counts in at least ", min_samples, " samples)")

rm(expressed)



# colnames(counts)
saveRDS(count_matrix, file.path(data_dir, paste0(tag,"_count_mat_stim.RDS")))
```



##### SampleAnnotation Stimulated
```{r}
DT::datatable(data.frame(sample_info),
              extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           pageLength = 5,           # Show 5 rows by default
                scrollX = TRUE)
            )

```





### 0.2 - un-stimulated data
```{r,message=F, warning=F}
# 
# Load count matrix
txi  <- readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_Ser213_unstim_2025/data/txi_kallisto_ser213_unstim.rds")

# In txi$counts rownames
clean_ids <- gsub("_.*", "", colnames(txi$counts))
colnames(txi$counts) <- clean_ids

tr2g <- readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_Ser213_unstim_2025/data/tr2g_kallisto_ser213_unstim.rds")

# Keep gene annotation if needed later
gene_info <- tr2g[, 1:3] 
colnames(gene_info) <- c("TranscriptID", "GeneID", "GeneSymbol")

# Clean Ensembl IDs
gene_info <- gene_info %>%
  dplyr::mutate(
    ensembl_vs = GeneID,
    GeneID = sub("\\.\\d+$", "", GeneID)  # strip version suffix from ENSG IDs
  ) %>%   distinct(ensembl_vs, .keep_all = TRUE)



library(DBI)
library(biomaRt)
# --- fetch biotypes using clean IDs ---
mart <- biomaRt::useEnsembl("ensembl", dataset = "hsapiens_gene_ensembl")

biotypes <- getBM(
  attributes = c("ensembl_gene_id", "gene_biotype"),
  filters    = "ensembl_gene_id",
  values     = unique(gene_info$GeneID),
  mart       = mart
) |>
  dplyr::distinct(ensembl_gene_id, .keep_all = TRUE)

gene_info <- gene_info %>% left_join(biotypes, by = join_by(GeneID == ensembl_gene_id)) %>%
  filter(ensembl_vs %in% rownames(txi$counts))


# Check for NA or negative counts
if (any(is.na(txi$counts)) || any(txi$counts < 0)) {
  stop("Invalid values (NA or negative) detected in count matrix.")
}




count_data <- txi$counts %>%
  as.data.frame() %>%
  tibble::rownames_to_column("ensembl_vs") %>%
  inner_join(gene_info, by = "ensembl_vs")

count_matrix <- count_data %>%
  filter(gene_biotype == "protein_coding")  %>%
  dplyr::select(-ensembl_vs,-TranscriptID,-gene_biotype,-GeneSymbol) %>%
  column_to_rownames("GeneID")


# Report
message("Retained ", nrow(count_matrix), " protein-coding genes after MT/ribo removal.")



## recreate gene_info

gene_info <- count_data %>%
  filter(gene_biotype == "protein_coding")  %>% dplyr::select(ensembl_vs,TranscriptID,GeneSymbol,GeneID) %>%
  mutate(rownames = GeneID) %>% column_to_rownames("rownames")




```

```{r,message=F, warning=F}
# --- Load and Format Metadata ---
meta_data <- read.csv("/srv/home/dkrauss/RProjects/RNASeq_Gregor_Ser213_unstim_2025/data/Mikulits_8samples_235HTCLT3_6_R19442_20250916_Metadata_Overview.csv",
  header      = TRUE,
  sep         = ",",
  nrows       = 8,
  strip.white = TRUE,
  check.names = FALSE
) %>%
  mutate(sampleID = as.character(sampleID)) %>%
  mutate(create_rownames = sampleID) %>%
  column_to_rownames("create_rownames")

# ensure every sample has metadata
missing_meta <- setdiff(colnames(txi$counts), meta_data$sampleID)
if (length(missing_meta)) {
  stop("Missing metadata for: ", paste(missing_meta, collapse=", "))
}

# reorder to match txi$counts
meta_data <- meta_data[match(colnames(txi$counts), meta_data$sampleID), ]


stopifnot(all(meta_data$sampleID == colnames(txi$counts)))


rm(missing_meta)

meta_data <- meta_data %>%
  dplyr::mutate(
    group = dplyr::case_when(
      Genotype == "wt"  ~ "WT",
      Genotype == "mut" ~ "MUT",
      TRUE ~ Genotype
      
      
    ),
    sampleID_num = sampleID,
    sampleID = paste0("X",sampleID),
    condition = c("unstimulated")
  )


```


```{r, eval = T, include = T, message=FALSE, warning=FALSE}
# --- Handle Duplicate Ensembl IDs ---
# --- Filter by Minimum Expression Threshold (Library Size) ---
# Filter out genes with low expression across all samples
# Retain genes ≥10 counts in ≥4 samples [fits for our 4x2 = 8 libraries]
min_count <- 10
min_samples <- 4

expressed <- rowSums(count_matrix >= min_count) >= min_samples
count_matrix <- count_matrix[expressed, ]
gene_info    <- gene_info[expressed, ]

message("Retained ", nrow(count_matrix),
        " genes after filtering by minimum expression (",
        min_count, " counts in at least ", min_samples, " samples)")

rm(expressed)




#######################################
# Collapse duplicate SYMBOL IDs by keeping the row with the highest library-size total
df <- count_matrix %>% rownames_to_column("GeneID") %>% left_join(gene_info) %>% dplyr::select(-GeneID,-ensembl_vs,-TranscriptID) %>% as.matrix()

rownames(df) <- df[,"GeneSymbol"]

df2 <- df[,c(colnames(count_matrix))]
storage.mode(df2) <- "integer"


dup_id <- duplicated(rownames(df2))
table(dup_id)  # view how many duplicates found                                                - 6 duplicates found

if (any(dup_id)) {
  message("Found ", sum(dup_id), " duplicate SYMBOL IDs – collapsing to one row each")
  
  # Compute per-gene library size across all samples
  libsize_vec <- rowSums(df2)
  gene_info_2 <- gene_info
  gene_info_2$libsize <- libsize_vec
  
  # Collapse count matrix using rownames as group                                               - groups by row name and sums the counts
  df2 <- rowsum(df2, group = rownames(df2))
  
  # Keep annotation row with highest expression for each gene
  gene_info_unique <- gene_info_2 %>%
    dplyr::group_by(GeneSymbol) %>%
    dplyr::slice_max(order_by = libsize, n = 1, with_ties = FALSE) %>%
    dplyr::ungroup() %>%
    dplyr::select(-libsize)
  
  # Align annotation with collapsed count matrix
  gene_info_2 <- gene_info_unique[match(rownames(df2), gene_info_unique$GeneSymbol), ]
}

# Consistency check
stopifnot(identical(rownames(df2), gene_info_2$GeneSymbol))

rm(dup_id)





##############



























# Collapse duplicate Ensembl IDs by keeping the row with the highest library-size total
dup_id <- duplicated(rownames(count_matrix))
table(dup_id)  # view how many duplicates found                                                - 0 duplicates found

# --- Handle Duplicate SYMBOL IDs ---
# Collapse duplicate SYMBOL IDs by keeping the row with the highest library-size total
dup_id <- duplicated(gene_info$GeneSymbol)
table(dup_id)  # view how many duplicates found                                                - 6 duplicates found


# First let's determine the gene means
gene_means <- rowMeans(data.frame(count_matrix))

# Let's add this as a column in our `mapped_df`.
mapped_df <- gene_info %>%
  # Add gene_means as a column called gene_means
  dplyr::mutate(gene_means) %>%
  # Reorder the columns so `gene_means` column is upfront
  dplyr::select(GeneID, GeneSymbol, gene_means, dplyr::everything())


filtered_mapped_df <- mapped_df %>%
  # Sort so that the highest mean expression values are at the top
  dplyr::arrange(dplyr::desc(gene_means)) %>%
  # Filter out the duplicated rows using `dplyr::distinct()`
  dplyr::distinct(GeneSymbol, .keep_all = TRUE)


count_matrix <- count_matrix %>% rownames_to_column("GeneID") %>% left_join(gene_info)
  
counts <- count_matrix %>% 
  dplyr::filter(GeneID %in% filtered_mapped_df$GeneID) %>%  tibble::column_to_rownames("GeneSymbol") %>% dplyr::select(-ensembl_vs,-TranscriptID,-GeneID) %>% round()



# We have now removed duplicates and ensured consistency between count_matrix and gene_info


all(rownames(counts) == rownames(df2[rownames(counts), , drop = FALSE]))


# colnames(counts)
saveRDS(counts, file.path(data_dir, paste0(tag,"_count_mat_unstim.RDS")))
```



##### SampleAnnotation Unstimulated

```{r}
DT::datatable(data.frame(meta_data),
              extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           pageLength = 5,           # Show 5 rows by default
                scrollX = TRUE)
            )

```



### 0.3 - compare count_matrices
```{r,message=F, warning=F}

counts_unstim <- readRDS(file.path(data_dir,paste0(tag, "_count_mat_unstim.RDS")))
counts_stim <- readRDS(file.path(data_dir,paste0(tag, "_count_mat_stim.RDS")))

## quick & dirty merging matrices by smallest one
length(setdiff(rownames(counts_unstim), rownames(counts_stim)))

length(intersect(rownames(counts_unstim), rownames(counts_stim)))

overlapping_genes <- intersect(rownames(counts_unstim), rownames(counts_stim))
 

prep_unstim <- counts_unstim %>% data.frame() %>% rownames_to_column("SYMBOL") %>% filter(SYMBOL %in% overlapping_genes)

counts <- counts_stim %>% data.frame() %>% rownames_to_column("SYMBOL") %>% filter(SYMBOL %in% overlapping_genes) %>% left_join(prep_unstim) %>% column_to_rownames("SYMBOL")
#dim(merge_counts)

# sample_info
# meta_data
sample_merge <- sample_info %>% dplyr::select(sampleID,group,condition) %>% rbind(meta_data %>%  dplyr::select(sampleID,group,condition))
rownames(sample_merge) <- sample_merge$sampleID

all(colnames(counts)==rownames(sample_merge))
```



------------------------------------------------------------------------


# 1 - DESeq2 Analysis {.tabset .tabset-pills}

## stimulated dds
```{r, message=F}
all(colnames(counts_stim) == rownames(sample_info))

dds_stim <- DESeqDataSetFromMatrix(countData = counts_stim,
                              colData = sample_info,
                              design = design_formula)

head(counts(dds_stim))[1:4,]

## keep only genes where we have >= 10 reads per samplecondition in total
keep <- rowSums(counts(collapseReplicates(dds_stim, dds_stim[[condition]]))) >= 10
dds_stim <- dds_stim[keep,]


# run DESeq
dds_stim <- DESeq(dds_stim) 

saveRDS(dds_stim, file.path(data_dir,paste0(tag ,"_dds_stim.rds")))


```



## un-stimulated dds
```{r, message=F}
all(colnames(counts_unstim) == rownames(meta_data))
dds_unstim <- DESeqDataSetFromMatrix(countData = counts_unstim,
                              colData = meta_data,
                              design = design_formula)

head(counts(dds_unstim))[1:4,]

## keep only genes where we have >= 10 reads per samplecondition in total
keep <- rowSums(counts(collapseReplicates(dds_unstim, dds_unstim[[condition]]))) >= 10
dds_unstim <- dds_unstim[keep,]


# run DESeq
dds_unstim <- DESeq(dds_unstim) 

saveRDS(dds_unstim, file.path(data_dir,paste0(tag ,"_dds_unstim.rds")))

```



## Combined dds


```{r eval=T, message=FALSE, warning=FALSE, include=T}
all(colnames(counts) == rownames(sample_merge))
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = sample_merge ,
                              design = design_formula) #  design_formula



head(counts(dds))[1:4,]

## keep only genes where we have >= 10 reads per samplecondition in total
keep <- rowSums(counts(collapseReplicates(dds, dds[[condition]]))) >= 10
dds <- dds[keep,]


# run DESeq
dds <- DESeq(dds) # includes estimateSizeFactors(),estimateDispersion(),nbinomWaldTest()

#plotDispEsts(dds)

saveRDS(dds, file.path(data_dir,paste0(tag ,"_dds_DESeq2.rds")))

```


------------------------------------------------------------------------


# 2 - Unsupervised Clustering {.tabset .tabset-pills}

#### Effects of transformations on the variance


Of combined analysis
```{r,fig.width = 12, eval = F}
# Get normalized counts
vst <- vst(dds, blind = FALSE)



# this gives log2(n + 1)
ntd <- normTransform(dds)

vsn::meanSdPlot(assay(ntd))
vsn::meanSdPlot(assay(vst))
```




#### PCA Plots {.tabset .tabset-pills}
Of combined object


```{r,eval=T, results='hide',fig.width = 12, fig.asp=0.6}
# Get normalized counts
vst <- vst(dds, blind = FALSE)



# this gives log2(n + 1)
ntd <- normTransform(dds)
vars <- colData(vst) %>% 
  colnames() %>% setdiff(c("sizeFactor")) %>% setdiff(c("replaceable"))


pca_plots <- vars %>%
  purrr::map(function(var) {
    plotPCA(vst, intgroup = var) + 
      scale_color_manual(values = get_colors()) +
      ggtitle(paste("PCA colored by", var))
  })
names(pca_plots) <- vars

src_list <- lapply(names(pca_plots), function(x) {
    src <- c("##### {{x}} {.unnumbered}",
             "```{r PCA2-{{x}}}",
             "pca_plots[['{{paste0(x)}}']]",
             "```",
             "")
    knit_expand(text = src)
})
out <- knit_child(text = unlist(src_list), options = list(cache = FALSE))
```
`r out`

#### CorrelationMaps & Dendrogram

```{r message=FALSE, warning=FALSE}
###### Correlationmap
vst_cor <- cor(assay(vst))


pheatmap::pheatmap(vst_cor, 
         intgroup = paste0(condition) ,
         color = rev(brewer.pal(11, "RdBu")), 
         fontsize = 10, 
         fontsize_row = 10, 
         height=20)



#Unsupervised clustering
plot(hclust(dist(t(assay(vst)))))

```




------------------------------------------------------------------------


# 3 - Results

## Hypothesis Testing {.tabset .tabset-pills}

### Combined

```{r, eval=FALSE, include = T, message=FALSE, warning=FALSE}
library(IHW)
dds <- readRDS(file.path(data_dir,paste0(tag, "_dds_DESeq2.rds")))


if(res_option == "normal"){
  results <- contrasts %>%
   purrr::map(function(x){
     results(dds, contrast = x, alpha = 0.05)
   })
  print("normal Res extract")
} else if(res_option =="lfc_shrink") {
  results <- contrasts %>%
   purrr::map(function(x){
     res_unshrunk <-results(dds, contrast = x, alpha = 0.05)
     lfcShrink(dds,contrast = x, 
               #type = "ashr",
               type = "normal",
               res = res_unshrunk) })
    print("Normal Results extract + LFC shrinkage added")
} else if(res_option == "ihw"){
   results <- contrasts %>%  
  purrr::map(function(x){
    results(dds, contrast = x, filterFun = ihw)})
  print("IHW result extract")
} else if(res_option == "ihw+shrink"){
   results <- contrasts %>%
  purrr::map(function(x){
     res_unshrunk <-  results(dds, contrast = x, filterFun = ihw) #, cooksCutoff=F
    res_shr <- lfcShrink(dds,
              contrast = x,
              type = "ashr", #type = "normal",
              res = res_unshrunk)
    attr(res_shr, "contrast_label") <- paste(x, collapse = "_")
    return(res_shr)

    })
  print("IHW result extract and LFC Shrinkage added")
  
  #lfcShrink(dds, contrast = x, type = "ashr", res = res_unshrunk) — replaces the raw log2FoldChange with a shrunken LFC (using ashr) while preserving the testing results from res_unshrunk (so you get the shrunken LFC but the p-values / padj coming from the IHW-based res_unshrunk).
# you want the IHW-adjusted p-values (better power) and the shrunken LFC for stable effect-size estimates.
}
  
saveRDS(results, file.path(results_dir,paste0(tag,"_res.RDS")))



# lapply(results, function(x) {
#   df <- as.data.frame(x)
#   rownames_to_column(df, var = "SYMBOL")
# }) %>% rio::export(here::here(results_dir, paste0(tag,"_all_res.xlsx" )))

```

### stim

```{r, eval=FALSE, include = T, message=FALSE, warning=FALSE}
dds <- readRDS(file.path(data_dir,paste0(tag, "_dds_stim.rds")))


library(IHW)
if(res_option == "normal"){
  results <- contrasts %>%
   purrr::map(function(x){
     results(dds, contrast = x, alpha = 0.05)
   })
  print("normal Res extract")
} else if(res_option =="lfc_shrink") {
  results <- contrasts %>%
   purrr::map(function(x){
     res_unshrunk <-results(dds, contrast = x, alpha = 0.05)
     lfcShrink(dds,contrast = x, 
               #type = "ashr",
               type = "normal",
               res = res_unshrunk) })
    print("Normal Results extract + LFC shrinkage added")
} else if(res_option == "ihw"){
   results <- contrasts %>%  
  purrr::map(function(x){
    results(dds, contrast = x, filterFun = ihw)})
  print("IHW result extract")
} else if(res_option == "ihw+shrink"){
   results <- contrasts %>%
  purrr::map(function(x){
     res_unshrunk <-  results(dds, contrast = x, filterFun = ihw) #, cooksCutoff=F
    res_shr <- lfcShrink(dds,
              contrast = x,
              type = "ashr", #type = "normal",
              res = res_unshrunk)
    attr(res_shr, "contrast_label") <- paste(x, collapse = "_")
    return(res_shr)

    })
  print("IHW result extract and LFC Shrinkage added")
  
  #lfcShrink(dds, contrast = x, type = "ashr", res = res_unshrunk) — replaces the raw log2FoldChange with a shrunken LFC (using ashr) while preserving the testing results from res_unshrunk (so you get the shrunken LFC but the p-values / padj coming from the IHW-based res_unshrunk).
# you want the IHW-adjusted p-values (better power) and the shrunken LFC for stable effect-size estimates.
}
  
saveRDS(results, file.path(results_dir,paste0(tag,"_res_stim.RDS")))

```

### unstim

```{r, eval=FALSE, include = T, message=FALSE, warning=FALSE}
dds <- readRDS(file.path(data_dir,paste0(tag, "_dds_unstim.rds")))

library(IHW)
if(res_option == "normal"){
  results <- contrasts %>%
   purrr::map(function(x){
     results(dds, contrast = x, alpha = 0.05)
   })
  print("normal Res extract")
} else if(res_option =="lfc_shrink") {
  results <- contrasts %>%
   purrr::map(function(x){
     res_unshrunk <-results(dds, contrast = x, alpha = 0.05)
     lfcShrink(dds,contrast = x, 
               #type = "ashr",
               type = "normal",
               res = res_unshrunk) })
    print("Normal Results extract + LFC shrinkage added")
} else if(res_option == "ihw"){
   results <- contrasts %>%  
  purrr::map(function(x){
    results(dds, contrast = x, filterFun = ihw)})
  print("IHW result extract")
} else if(res_option == "ihw+shrink"){
   results <- contrasts %>%
  purrr::map(function(x){
     res_unshrunk <-  results(dds, contrast = x, filterFun = ihw) #, cooksCutoff=F
    res_shr <- lfcShrink(dds,
              contrast = x,
              type = "ashr", #type = "normal",
              res = res_unshrunk)
    attr(res_shr, "contrast_label") <- paste(x, collapse = "_")
    return(res_shr)

    })
  print("IHW result extract and LFC Shrinkage added")
  
  #lfcShrink(dds, contrast = x, type = "ashr", res = res_unshrunk) — replaces the raw log2FoldChange with a shrunken LFC (using ashr) while preserving the testing results from res_unshrunk (so you get the shrunken LFC but the p-values / padj coming from the IHW-based res_unshrunk).
# you want the IHW-adjusted p-values (better power) and the shrunken LFC for stable effect-size estimates.
}
  
saveRDS(results, file.path(results_dir,paste0(tag,"_res_unstim.RDS")))


```


## Plot comparisons  {.tabset .tabset-pills}




```{r}
## load result tables for each comparison

res_list <- list(res_stim = readRDS(file.path(results_dir,paste0(tag, "_res_stim.RDS"))),
                 res_unstim = readRDS(file.path(results_dir,paste0(tag, "_res_unstim.RDS"))),
                 res_combined = readRDS(file.path(results_dir,paste0(tag, "_res.RDS")))

)

# lapply(names(res_list), function(nm) {
#   cat("\n=== ", nm, " ===\n")
#   summary(res_list[[nm]]$Ser213_MUT_vs_WT)
# })


sig_unstim <- res_list$res_unstim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))

sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))

sig_combined <- res_list$res_combined$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))


overlap_genes <- intersect(sig_unstim$gene, sig_stim$gene)
cat("\n=== ", "Number of overlapping Genes (padj = 0.05 & log2FC >1/<-1)", " ===\n")
length(overlap_genes)


# Three-way overlap (stim, unstim, combined)
overlap_genes_3way <- Reduce(intersect, list(sig_unstim$gene, sig_stim$gene, sig_combined$gene))
cat("\n=== Number of overlapping Genes (padj = 0.05 & log2FC >1/<-1) across stim, unstim & combined ===\n")
length(overlap_genes_3way)

```

### N° of DEG genes {.tabset .tabset-pills}
#### all sig DEGs
```{r, NoGenes,fig.width = 12}

de.list <- lapply(X = res_list, FUN = function(x) {
  x <- x$Ser213_MUT_vs_WT %>%
    base::data.frame() %>%
    filter(padj < 0.05) %>%
    rownames_to_column("Gene") %>%
    dplyr::select(Gene = Gene, LogFC = log2FoldChange, pVal = padj) %>%
    arrange(desc(LogFC))
})

de.summary <- de.list %>%
    map2_df(names(de.list), ~ mutate(.x, Comparison = .y)) %>%
    mutate(IsUp = LogFC > 0) %>%
    group_by(Comparison) %>%
    summarise(Up = sum(IsUp), Down = sum(!IsUp)) %>%
    mutate(Down = -Down) %>%
    pivot_longer(cols = c(Up, Down), names_to = "Direction", values_to = "Count") %>%
    mutate(Comparison = factor(Comparison, levels = names(de.list)))

ggplot(de.summary,
       aes(x = fct_rev(Comparison), y = Count, fill = Direction)) +
    geom_col() +
    geom_text(aes(y = Count + sign(Count) * max(abs(Count)) * 0.07,
                  label = abs(Count)),
              size = 6, colour = "grey25") +
    coord_flip() +
    scale_fill_manual(values = c("#377eb8", "#e41a1c")) +
    ggtitle("Number of identified genes (padj < 0.05)") +
    theme(axis.title = element_blank(),
          axis.line = element_blank(),
          axis.ticks = element_blank(),
          axis.text.x = element_blank(),
          legend.position = "bottom")



```

#### sig & FC DEGs
```{r,fig.width = 12}

de.summary.strict <- de.list %>%
    map2_df(names(de.list), ~ mutate(.x, Comparison = .y)) %>%
    # apply stricter filters
    filter(pVal < 0.05, abs(LogFC) > 1) %>%
    mutate(IsUp = LogFC > 1) %>%           # upregulated
    mutate(IsDown = LogFC < -1) %>%        # downregulated
    group_by(Comparison) %>%
    summarise(
        Up = sum(IsUp),
        Down = sum(IsDown)
    ) %>%
    mutate(Down = -Down) %>%  # make Down negative for the plot
    tidyr::pivot_longer(
        cols = c(Up, Down),
        names_to = "Direction",
        values_to = "Count"
    ) %>%
    mutate(
        Comparison = factor(Comparison, levels = names(de.list))
    )

ggplot(de.summary.strict,
       aes(x = fct_rev(Comparison), y = Count, fill = Direction)) +
    geom_col() +
    geom_text(aes(y = Count + sign(Count) * max(abs(Count)) * 0.07,
                  label = abs(Count)),
              size = 6, colour = "grey25") +
    coord_flip() +
    scale_fill_manual(values = c("#377eb8", "#e41a1c")) +
    ggtitle("Number of identified genes (padj < 0.05 & |log2FC| > 1)") +
    theme(axis.title = element_blank(),
          axis.line = element_blank(),
          axis.ticks = element_blank(),
          axis.text.x = element_blank(),
          legend.position = "bottom")




```

### Upset Plots  {.tabset .tabset-pills}
#### all sig

FDR = 0.05 & |log2FC| >1
A single filled dot = elements unique to that set

How to read upsetPlots:

-   One filled dot → set-specific genes
-   Two filled dots → genes shared only by those two sets
-   Three filled dots → genes shared by all three
```{r}
library(UpSetR)

upset_data <- list(
  DESeq2_unstim = sig_unstim$gene,
  DESeq2_stim = sig_stim$gene
)

upset(fromList(upset_data),
      order.by = "freq",
      sets.bar.color = c("steelblue", "firebrick"))


library(UpSetR)

# UpSet plot with three sets
upset_data <- list(
  DESeq2_unstim    = sig_unstim$gene,
  DESeq2_stim      = sig_stim$gene,
  DESeq2_combined  = sig_combined$gene
)

upset(
  fromList(upset_data),
  order.by = "freq",
  set_size.show = TRUE,nsets = 3,
  sets.bar.color = c("steelblue", "firebrick", "forestgreen")  # added color for third set
)



# get all unique genes
all_genes <- unique(unlist(upset_data))
# initialize dataframe
gene_df <- data.frame(
  gene = all_genes,
  stringsAsFactors = FALSE
)

# add one column per condition
for (cond in names(upset_data)) {
  gene_df[[cond]] <- as.integer(gene_df$gene %in% upset_data[[cond]])
}

```

#### up-vs-dn

Differentiate between classes up vs. dn
```{r}
upset_data <- list(
  DESeq2_unstim_UP = sig_unstim %>% filter(direction == "UP") %>% pull(gene),
  DESeq2_unstim_DOWN = sig_unstim %>% filter(direction == "DOWN") %>% pull(gene),
  DESeq2_stim_UP = sig_stim %>% filter(direction == "UP") %>% pull(gene),
  DESeq2_stim_DOWN = sig_stim %>% filter(direction == "DOWN") %>% pull(gene)
  )

upset(fromList(upset_data),
      order.by = "freq",
      sets.bar.color = c( "firebrick","firebrick","steelblue","steelblue"))
```

#### only-up
```{r}
upset_data <- list(
  DESeq2_unstim_UP = sig_unstim %>% filter(direction == "UP") %>% pull(gene),
  DESeq2_stim_UP = sig_stim %>% filter(direction == "UP") %>% pull(gene)  )

upset(fromList(upset_data),
      order.by = "freq",
      sets.bar.color = c("steelblue", "firebrick"))
```


#### only-down
```{r}
upset_data <- list(
  DESeq2_unstim_DOWN = sig_unstim %>% filter(direction == "DOWN") %>% pull(gene),
  DESeq2_stim_DOWN = sig_stim %>% filter(direction == "DOWN") %>% pull(gene)  )

upset(fromList(upset_data),
      order.by = "freq",
      sets.bar.color = c("steelblue", "firebrick"))
```

#### top_n UP vs. padj

FDR = 0.01 & |log2FC| >1
top_n by log2FC or top_n by padj
```{r}


sig_unstim <- res_list$res_unstim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>% arrange(-log2FoldChange) %>% top_n( 100, log2FoldChange)

sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>% arrange(-log2FoldChange) %>% top_n( 100, log2FoldChange)



library(UpSetR)

# UpSet plot with three sets
upset_data <- list(
  DESeq2_unstim    = sig_unstim$gene,
  DESeq2_stim      = sig_stim$gene
)

upset(
  fromList(upset_data),
  order.by = "freq",
  sets.bar.color = c("steelblue", "firebrick")  # added color for third set
)




sig_unstim <- res_list$res_unstim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, (log2FoldChange) > 1) %>% arrange(padj) %>% top_n( 100, padj)

sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, (log2FoldChange) > 1) %>% arrange(padj) %>% top_n( 100, log2FoldChange)


library(UpSetR)

# UpSet plot with three sets
upset_data <- list(
  DESeq2_unstim    = sig_unstim$gene,
  DESeq2_stim      = sig_stim$gene
)

upset(
  fromList(upset_data),
  order.by = "freq",
  sets.bar.color = c("steelblue", "firebrick")  # added color for third set
)



```


#### top_n DOWN vs. padj

FDR = 0.01 & log2FC >-1
top_n by log2FC or top_n by padj
```{r}
sig_unstim <- res_list$res_unstim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    )) 

sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    )) 


library(UpSetR)

# UpSet plot with three sets
upset_data <- list(
  DESeq2_unstim    =  sig_unstim %>% filter(direction == "DOWN") %>% pull(gene),
  DESeq2_stim      = sig_stim %>% filter(direction == "DOWN") %>% pull(gene)
)

upset(
  fromList(upset_data),
  order.by = "freq",
  sets.bar.color = c("steelblue", "firebrick")  # added color for third set
)



```



### Venn {.tabset .tabset-pills}
#### all sig

```{r,fig.width = 12}


sig_unstim <- res_list$res_unstim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))

sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))

sig_combined <- res_list$res_combined$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))



genes_list <- list(
  DESeq2_unstim = sig_unstim$gene,
  DESeq2_stim   = sig_stim$gene
)

library(ggVennDiagram)

ggVennDiagram(genes_list, label_alpha = 0) +
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme_void() +
    theme(
        plot.margin = margin(20, 40, 20, 40)  # extra space left/right
    ) +
    coord_cartesian(clip = "off")




# Create the list of gene sets including the third one
genes_list <- list(
  DESeq2_unstim    = sig_unstim$gene,
  DESeq2_stim      = sig_stim$gene,
  DESeq2_combined  = sig_combined$gene
)

library(ggVennDiagram)

# Venn diagram with three sets
ggVennDiagram(genes_list, label_alpha = 0) +
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme_void() +
    theme(
        plot.margin = margin(20, 40, 20, 40)  # extra space left/right
    ) +
    coord_cartesian(clip = "off")






```


#### only down

```{r,fig.width = 12}
genes_list <- list(
  DESeq2_unstim = sig_unstim %>% filter(direction == "DOWN") %>% pull(gene),
  DESeq2_stim   = sig_stim %>% filter(direction == "DOWN") %>% pull(gene)
)

library(ggVennDiagram)

ggVennDiagram(genes_list, label_alpha = 0) +
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme_void() +
    theme(
        plot.margin = margin(20, 40, 20, 40)  # extra space left/right
    ) +
    coord_cartesian(clip = "off")

```



#### only up

```{r,fig.width = 12}
genes_list <- list(
  DESeq2_unstim = sig_unstim %>% filter(direction == "UP") %>% pull(gene),
  DESeq2_stim   = sig_stim %>% filter(direction == "UP") %>% pull(gene)
)

library(ggVennDiagram)

ggVennDiagram(genes_list, label_alpha = 0) +
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme_void() +
    theme(
        plot.margin = margin(20, 40, 20, 40)  # extra space left/right
    ) +
    coord_cartesian(clip = "off")

```











### scatter {.tabset .tabset-pills}
#### Directions

```{r,fig.width = 10}
library(ggplot2)
overlap_genes <- intersect(sig_unstim$gene, sig_stim$gene)
cat("\n=== ", "Number of overlapping Genes (padj = 0.05 & log2FC >1/<-1)", " ===\n")
length(overlap_genes)



merged <- merge(
  res_list$res_stim$Ser213_MUT_vs_WT %>% as.data.frame() %>% rownames_to_column("gene"),
  res_list$res_unstim$Ser213_MUT_vs_WT %>% as.data.frame() %>% rownames_to_column("gene"),
  by = "gene",
  suffixes = c("_stim", "_unstim")
)

merged$overlap <- merged$gene %in% overlap_genes

ggplot(merged, aes(log2FoldChange_stim, log2FoldChange_unstim)) +
  geom_point(aes(color = overlap), alpha = 0.6) +
  scale_color_manual(values = c("grey70", "steelblue")) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(
    title = "Log2 Fold Change Comparison",
    x = "log2FC (DESeq2 stimulated)",
    y = "log2FC (DESeq2 unstimulated)",
    color = "Overlapping genes"
  )


overlap_df <- merged %>%
  filter(gene %in% overlap_genes) %>%
  mutate(
    direction_res1 = sign(log2FoldChange_stim),
    direction_res2 = sign(log2FoldChange_unstim),
    same_direction = direction_res1 == direction_res2
  )

table(overlap_df$same_direction)



merged2 <- merged %>%
  mutate(
    overlap = gene %in% overlap_genes,
    same_direction = ifelse(
      overlap,
      sign(log2FoldChange_stim) == sign(log2FoldChange_unstim),
      NA
    )
  )
# table(merged2$same_direction)

label_df <- merged2 %>%
  filter(overlap) %>%
  mutate(effect_size = abs(log2FoldChange_stim) + abs(log2FoldChange_unstim)) %>%
  group_by(same_direction) %>%
  slice_max(effect_size, n = 15) %>%
  ungroup()



library(ggplot2)
library(ggrepel)

ggplot(merged2, aes(log2FoldChange_stim, log2FoldChange_unstim)) +

  # Base layer: all genes
  geom_point(color = "grey75", alpha = 0.4) +

  # Overlapping genes (colored by direction agreement)
  geom_point(
    data = merged2 %>% filter(overlap),
    aes(color = same_direction),
    alpha = 0.8
  ) +

  # Direction colors
  scale_color_manual(
    values = c(
      "TRUE"  = "steelblue",
      "FALSE" = "firebrick"
    ),
    labels = c(
      "TRUE"  = "Same direction",
      "FALSE" = "Opposite direction"
    ),
    na.translate = FALSE
  ) +

  # Labels for top genes
  geom_text_repel(
    data = label_df,
    aes(label = gene, color = same_direction),
    size = 3,
    max.overlaps = Inf,
    box.padding = 0.4,
    show.legend = FALSE
  ) +

  # Reference lines
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +

  theme_minimal() +
  labs(
    title = "Log2 Fold Change Comparison",
    subtitle = "Overlapping genes: same vs opposite regulation",
    x = "log2FC (DESeq2 stimulated)",
    y = "log2FC (DESeq2 unstimulated)",
    color = "Direction consistency"
  )


```




#### Combined analysis
```{r,fig.width = 10}
# Merge the third comparison

# overlap_genes_3way


library(dplyr)
library(ggplot2)
library(ggrepel)

# Add a new overlap category
merged2 <- merged2 %>%
  mutate(
    overlap_category = case_when(
      gene %in% overlap_genes_3way ~ "Three-way overlap",
      overlap ~ "Two-way overlap",
      TRUE ~ "Other genes"
    )
  )

## sanity check
table(merged2$overlap_category)

# Update label_df if needed (optional: keep previous logic for top genes)
label_df <- merged2 %>%
  filter(overlap) %>%
  mutate(effect_size = abs(log2FoldChange_stim) + abs(log2FoldChange_unstim)) %>%
  group_by(same_direction) %>%
  slice_max(effect_size, n = 15) %>%
  ungroup()

# Plot
ggplot(merged2, aes(log2FoldChange_stim, log2FoldChange_unstim)) +

  # Base layer: all genes
  geom_point(data = merged2 %>% filter(overlap_category == "Other genes"),
             color = "grey75", alpha = 0.4) +

  # Overlapping genes colored by category
  geom_point(data = merged2 %>% filter(overlap_category != "Other genes"),
             aes(color = overlap_category),
             alpha = 0.8) +

  # Color scale
  scale_color_manual(
    values = c(
      "Two-way overlap"   = "steelblue",
      "Three-way overlap" = "forestgreen"
    )
  ) +

  # Labels for top genes (optional)
  geom_text_repel(
    data = label_df,
    aes(label = gene, color = same_direction),
    size = 3,
    max.overlaps = Inf,
    box.padding = 0.4,
    show.legend = FALSE
  ) +

  # Reference lines
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +

  theme_minimal() +
  labs(
    title = "Log2 Fold Change Comparison",
    subtitle = "Overlapping genes: same vs opposite regulation",
    x = "log2FC (DESeq2 stimulated)",
    y = "log2FC (DESeq2 unstimulated)",
    color = "Overlap category"
  )




```
















---------------------------------------------------------------------

# 4 - Signatures
## Collect all available signatures
Load all generated gene-lists, combine and save for quick loading

1. all comparisons of stim-vs-unstimulated
  -> extract top100 by log2FC and by p_adj
  
2. Leaderboard as generated by Gregor (wald statistics)


3. https://pmc.ncbi.nlm.nih.gov/articles/PMC2762280/#S7
  -> Based on table 2; please double check

4. https://www.sciencedirect.com/science/article/abs/pii/S0016508517361449
  -> Chen et al; 


```{r, eval = F}
res_list <- list(res_stim =
         readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/results/01-RNASeq_Gregor_2025_combined_res_stim.RDS"),
                 res_unstim = readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/results/01-RNASeq_Gregor_2025_combined_res_unstim.RDS"),
                 res_combined = readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/results/01-RNASeq_Gregor_2025_combined_res.RDS")

)


sig_unstim <- res_list$res_unstim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))

sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  mutate(
    direction = case_when(
      log2FoldChange >  1  ~ "UP",
      log2FoldChange < -1  ~ "DOWN"
    ))

merged <- merge(
  res_list$res_stim$Ser213_MUT_vs_WT %>% as.data.frame() %>% rownames_to_column("gene"),
  res_list$res_unstim$Ser213_MUT_vs_WT %>% as.data.frame() %>% rownames_to_column("gene"),
  by = "gene",
  suffixes = c("_stim", "_unstim")
)



### generated a genelist that is relevant in both stimulated & ustimulated conditions
### exclude genes that are specific for one condition

overlap_genes <- intersect(sig_unstim$gene, sig_stim$gene)
cat("\n=== ", "Number of overlapping Genes (padj = 0.05 & log2FC >1/<-1)", " ===\n")
length(overlap_genes)


merged$overlap <- merged$gene %in% overlap_genes # between stim and unstim

merged2 <- merged %>%
  mutate(
    overlap = gene %in% overlap_genes,
    same_direction = ifelse(
      overlap,
      sign(log2FoldChange_stim) == sign(log2FoldChange_unstim),
      NA
    )
  )



### extract genes only up & with base mean >10
res_filt  <- merged2 %>%
  dplyr::filter(#overlap_category == "Three-way overlap",
                same_direction == TRUE,
                baseMean_stim > 10,
                baseMean_unstim > 10,
                padj_stim <= 0.01,# results same as 0.05
                padj_unstim <= 0.01,# same as 0.05
                abs(log2FoldChange_stim) > 1,
                abs(log2FoldChange_unstim) > 1
                ) 


top50_up <- res_filt %>%
  dplyr::filter(log2FoldChange_stim > 1) %>%
  arrange(padj_stim) %>% #padj_stim
  slice_head(n = 50) %>%
  pull(gene)
  

top50_dn <- res_filt %>%
  dplyr::filter(log2FoldChange_stim < -1) %>%
  arrange(padj_stim) %>% #padj_stim
  slice_head(n = 50) %>%
  pull(gene)

top100_up <- res_filt %>%
  dplyr::filter(log2FoldChange_stim > 1) %>%
  arrange(padj_stim) %>% #padj_stim
  slice_head(n = 100) %>%
  pull(gene)
  

top100_dn <- res_filt %>%
  dplyr::filter(log2FoldChange_stim < -1) %>%
  arrange(padj_stim) %>% #padj_stim
  slice_head(n = 100) %>%
  pull(gene)


##### by log2FC
top50_up_FC <- res_filt %>%
  dplyr::filter(log2FoldChange_stim > 1) %>%
  arrange(log2FoldChange_stim) %>% #padj_stim
  slice_head(n = 50) %>%
  pull(gene)
  

top50_dn_FC <- res_filt %>%
  dplyr::filter(log2FoldChange_stim < -1) %>%
  arrange(log2FoldChange_stim) %>% #padj_stim
  slice_head(n = 50) %>%
  pull(gene)

top100_up_FC <- res_filt %>%
  dplyr::filter(log2FoldChange_stim > 1) %>%
  arrange(log2FoldChange_stim) %>% #padj_stim
  slice_head(n = 100) %>%
  pull(gene)
  

top100_dn_FC <- res_filt %>%
  dplyr::filter(log2FoldChange_stim < -1) %>%
  arrange(log2FoldChange_stim) %>% #padj_stim
  slice_head(n = 100) %>%
  pull(gene)


### previous collection from TCGA script
ser_signatures <- readRDS("/srv/workspace/rprojects/dkrauss/RNASeq_Gregor_TCGA_2025/data/collected_SerSignatures.Rds")


leaderboard_up <- read_delim("/srv/workspace/rprojects/dkrauss/RNASeq_Gregor_TCGA_2025/data/Ser213_signature_UP_topN_byWaldZ_T100_LFC1_FDR0.01.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% pull(gene)

leaderboard_dn <- read_delim("/srv/workspace/rprojects/dkrauss/RNASeq_Gregor_TCGA_2025/data/Ser213_signature_DN_topN_byWaldZ_T100_LFC1_FDR0.01.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% pull(gene)

all(leaderboard_up %in% ser_signatures$Leaderboard_up)
all(leaderboard_dn %in% ser_signatures$Leaderboard_dn)

### load refined gene list
leaderboard_SOTA <- read_delim("/srv/workspace/rprojects/dkrauss/RNASeq_Gregor_TCGA_2025/data/Ser213_UP_core_SOTA.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% pull(gene)
all(leaderboard_SOTA %in% ser_signatures$Leaderboard_up)





#### publically availavle genesets
Coulouarn_et_al_signature <- read_csv("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/data/Coulouarn_et_al_signature.csv") %>% pull("Gene symbol")

chen_et_al <- c("SMAD3", "SPTBN1","SMAD4","SMAD5", "SMAD7", "TGFBR1", "TGFBR2","ACVR2A","EP300","CREBBP","RUNX2","CTCF", "DLG1", "BMPR1A","BMPR2", "TGFB1","TGFB3", # table 3 part 1
"ARID1A", "ARID2","RAD51D","ATM","ATR","BRCA1","BRCA2","FANCM","FANCF", "CDKN1B","TP53" ) # table 3 part 4



## collect in one list 
compare_genesets <- list(
  top100_up_p         = top100_up,
  top100_dn_p         = top100_dn,
  top50_up_p         = top50_up,
  top50_dn_p         = top50_dn,
  
  top100_up         = top100_up_FC,
  top100_dn         = top100_dn_FC,
  top50_up         = top50_up_FC,
  top50_dn         = top50_dn_FC,
  
  Leaderboard_up   = leaderboard_up,
  Leaderboard_dn   = leaderboard_dn,
  refined          = leaderboard_SOTA,
  coulouarn        = Coulouarn_et_al_signature,
  chen             = chen_et_al
)

saveRDS(compare_genesets,file.path(data_dir,"collected_SerSignatures_extended.Rds"))




```


### Scatter plots {.tabset .tabset-pills}
#### Leaderboard-vs-refined




```{r,fig.width = 10}
compare_genesets <- readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/data/collected_SerSignatures_extended.Rds")


### vs. log2FC & pval thresholds
sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  data.frame() %>%
  filter(!is.na(padj)) %>%          # remove NA adjusted p-values
  filter(padj < 0.05 & abs(log2FoldChange) > 1) %>%
  arrange(desc(abs(log2FoldChange))) # optional: sort by effect size

# Top 100 up-regulated genes
top_up <- sig_stim %>%
  filter(log2FoldChange > 1) %>%
  arrange(desc(log2FoldChange)) %>%
  slice_head(n = 100)

# Top 100 down-regulated genes
top_down <- sig_stim %>%
  filter(log2FoldChange < -1) %>%
  arrange(log2FoldChange) %>%  # more negative first
  slice_head(n = 100)

top_signature <- bind_rows(top_up, top_down)

leaderboard_all <- c(compare_genesets$Leaderboard_up,compare_genesets$Leaderboard_dn)

### check how many overlap

table(leaderboard_all %in% compare_genesets$refined )




merged3 <- merged2 %>%
  mutate(category = case_when(
    gene %in% compare_genesets$refined ~ "Refined Genelist",    # SOTA/Refined first
    gene %in% leaderboard_all           ~ "Leaderboard Gene",   # then leaderboard
    TRUE                               ~ "Other genes"         # everything else
  ))







# Plot
ggplot(merged3, aes(log2FoldChange_stim, log2FoldChange_unstim)) +
    
    # Base layer: all genes
    geom_point(data = merged3 %>% filter(category == "Other genes"),
               color = "grey75", alpha = 0.4) +
    
    # Highlighted genes
    geom_point(data = merged3 %>% filter(category != "Other genes"),
               aes(color = category),
               alpha = 0.8) +
    
    # Color scale
    scale_color_manual(
        values = c(
            "Refined Genelist"  = "darkorange",
            "Leaderboard Gene"  = "forestgreen"
        )
    ) +
    
    # Labels (if you want)
    geom_text_repel(
        data = label_df,
        aes(label = gene, color = same_direction),  # adjust if needed
        size = 3,
        #max.overlaps = Inf,
        box.padding = 0.4,
        show.legend = FALSE
    ) +
    
    # Reference lines
    geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    
    theme_minimal() +
    labs(
        title = "Log2 Fold Change Comparison MUT vs. WT",
        subtitle = "Refined and Leaderboard genes highlighted",
        x = "log2FC (DESeq2 stimulated)",
        y = "log2FC (DESeq2 unstimulated)",
        color = "Category"
    )

ggplot(merged3, aes(log2FoldChange_stim, log2FoldChange_unstim)) +

  # Base layer: all other genes
  geom_point(data = merged3 %>% filter(category == "Other genes"),
             color = "grey75", alpha = 0.4) +

  # Highlighted genes
  geom_point(data = merged3 %>% filter(category != "Other genes"),
             aes(color = category),
             alpha = 0.8) +

  # Color scale
  scale_color_manual(
    values = c(
      "Refined Genelist"  = "darkorange",
      "Leaderboard Gene"  = "forestgreen"
    )
  ) +

  # Label all Refined genes
  geom_text_repel(
    data = merged3 %>% filter(category == "Refined Genelist"),
    aes(label = gene),
    size = 3,
    max.overlaps = Inf,
    box.padding = 0.4,
    show.legend = FALSE
  ) +

  # Reference lines
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +

  theme_minimal() +
  labs(
    title = "Log2 Fold Change Comparison",
    subtitle = "All Refined Genelist genes labeled",
    x = "log2FC (DESeq2 stimulated)",
    y = "log2FC (DESeq2 unstimulated)",
    color = "Category"
  )


```



#### Leaderboard-vs-down
```{r,fig.width = 10}
compare_genesets <- readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/data/collected_SerSignatures_extended.Rds")


### vs. log2FC & pval thresholds
sig_stim <- res_list$res_stim$Ser213_MUT_vs_WT %>%
  data.frame() %>%
  filter(!is.na(padj)) %>%          # remove NA adjusted p-values
  filter(padj < 0.05 & abs(log2FoldChange) > 1) %>%
  arrange(desc(abs(log2FoldChange))) # optional: sort by effect size

# Top 100 up-regulated genes
top_up <- sig_stim %>%
  filter(log2FoldChange > 1) %>%
  arrange(desc(log2FoldChange)) %>%
  slice_head(n = 100)

# Top 100 down-regulated genes
top_down <- sig_stim %>%
  filter(log2FoldChange < -1) %>%
  arrange(log2FoldChange) %>%  # more negative first
  slice_head(n = 100)

top_signature <- bind_rows(top_up, top_down)

leaderboard_all <- c(compare_genesets$Leaderboard_up,compare_genesets$Leaderboard_dn)

### check how many overlap

table(leaderboard_all %in% rownames(top_signature))

both <- c(leaderboard_all, compare_genesets$top50_dn)
unique_top50 <- setdiff(compare_genesets$top50_dn, leaderboard_all)


merged3 <- merged2 %>%
  mutate(category = case_when(
    gene %in% unique_top50                    ~ "Unique top50", 
    gene %in% compare_genesets$top50_dn ~ "Top 50 down",    # SOTA/Refined first
    gene %in% leaderboard_all           ~ "Leaderboard Gene",   # then leaderboard
    
    TRUE                               ~ "Other genes"         # everything else
  ))




# Plot
ggplot(merged3, aes(log2FoldChange_stim, log2FoldChange_unstim)) +
    
    # Base layer: all genes
    geom_point(data = merged3 %>% filter(category == "Other genes"),
               color = "grey75", alpha = 0.4) +
    
    # Highlighted genes
    geom_point(data = merged3 %>% filter(category != "Other genes"),
               aes(color = category),
               alpha = 0.8) +
    
    # Color scale
    scale_color_manual(
        values = c("Unique top50"    = "darkblue",
            "Leaderboard Gene"  = "forestgreen",
            "Top 50 down"  = "darkorange"
            
            
        )
    )  +

  # Label all Refined genes
  # Reference lines
    geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    
    theme_minimal() +
    


    labs(
        title = "Log2 Fold Change Comparison MUT vs. WT",
        subtitle = "TOP 50 DN and Leaderboard genes highlighted",
        x = "log2FC (DESeq2 stimulated)",
        y = "log2FC (DESeq2 unstimulated)",
        color = "Category"
    )





# Plot
ggplot(merged3, aes(log2FoldChange_stim, log2FoldChange_unstim)) +
    
    # Base layer: all genes
    geom_point(data = merged3 %>% filter(category == "Other genes"),
               color = "grey75", alpha = 0.4) +
    
    # Highlighted genes
    geom_point(data = merged3 %>% filter(category != "Other genes"),
               aes(color = category),
               alpha = 0.8) +
    
    # Color scale
    scale_color_manual(
        values = c("Unique top50"    = "darkblue",
            "Leaderboard Gene"  = "forestgreen",
            "Top 50 down"  = "darkorange"
            
            
        )
    )  +

  # Label all Refined genes
  geom_text_repel(
    #data = merged3 %>% filter(category == "Refined Genelist"),
    aes(label = gene),
    size = 3,
    max.overlaps = Inf,
    box.padding = 0.4,
    show.legend = FALSE
  ) +    # Reference lines
    geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    
    theme_minimal() +
    


    labs(
        title = "Log2 Fold Change Comparison MUT vs. WT",
        subtitle = "TOP 50 DN and Leaderboard genes highlighted",
        x = "log2FC (DESeq2 stimulated)",
        y = "log2FC (DESeq2 unstimulated)",
        color = "Category"
    )










```


#### Coulouarn-vs-top_N
```{r,fig.width = 12, fig.asp=0.6}
compare_genesets <- readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/data/collected_SerSignatures_extended.Rds")
### check how many overlap

table(compare_genesets$coulouarn %in% rownames(top_signature))

leaderboard_all <- c(compare_genesets$Leaderboard_up,compare_genesets$Leaderboard_dn)


merged3 <- merged2 %>%
  mutate(category = case_when(
    gene %in% leaderboard_all ~ "Leaderboard Gene",    # SOTA/Refined first
    gene %in% compare_genesets$coulouarn  ~ "Coulouarn Gene",   # then 
    TRUE                               ~ "Other genes"         # everything else
  ))



# Sanity check
table(merged3$category)



# Plot
ggplot(merged3, aes(log2FoldChange_stim, log2FoldChange_unstim)) +
    
    # Base layer: all genes
    geom_point(data = merged3 %>% filter(category == "Other genes"),
               color = "grey75", alpha = 0.4) +
    
    # Highlighted genes
    geom_point(data = merged3 %>% filter(category != "Other genes"),
               aes(color = category),
               alpha = 0.8) +
    
    # Color scale
    scale_color_manual(
        values = c(
            "Coulouarn Gene"  = "darkorange",
            "Leaderboard Gene"  = "forestgreen"
        )
    ) +
    
    # Labels (if you want)
    geom_text_repel(
        data = label_df,
        aes(label = gene, color = same_direction),  # adjust if needed
        size = 3,
        max.overlaps = Inf,
        box.padding = 0.4,
        show.legend = FALSE
    ) +
    
    # Reference lines
    geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    
    theme_minimal() +
    labs(
        title = "Log2 Fold Change Comparison MUT vs. WT",
        subtitle = "Coulouarn and Leaderboard genes highlighted",
        x = "log2FC (DESeq2 stimulated)",
        y = "log2FC (DESeq2 unstimulated)",
        color = "Category"
    )

```


#### Chen-vs-top_N
none of the genes are present in either signature
```{r,fig.width = 12, fig.asp=0.6}
compare_genesets <- readRDS("/srv/home/dkrauss/RProjects/RNASeq_Gregor_2025/data/collected_SerSignatures_extended.Rds")
### check how many overlap

table(compare_genesets$chen %in% rownames(top_signature))
table(compare_genesets$chen %in% rownames(leaderboard_all))


```


#### Venn Leaderboard UP

```{r,fig.width = 12}
genes_list <- list(
  #top_UP_pval    = compare_genesets$top100_up_p,
  top_DN_FC      = compare_genesets$top100_dn,
  all_sig_UP     = res_list$res_stim$Ser213_MUT_vs_WT %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
    pull(gene),
  #Leaderboard_wald2 = sig_UP$gene,
  
  Leaderboard_wald = compare_genesets$Leaderboard_up
  
)

library(ggVennDiagram)

ggVennDiagram(genes_list, label_alpha = 0) +
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme_void() +
    theme(
        plot.margin = margin(20, 40, 20, 40)  # extra space left/right
    ) +
    coord_cartesian(clip = "off")

```

#### Venn Leaderboard DN

```{r,fig.width = 12}
genes_list <- list(
  #top_UP_pval    = compare_genesets$top100_up_p,
  top_UP_FC      = compare_genesets$top100_up,
  all_sig_UP     = res_list$res_stim$Ser213_MUT_vs_WT %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
    pull(gene),
  #Leaderboard_wald2 = sig_UP$gene,
  
  Leaderboard_wald = compare_genesets$Leaderboard_dn
  
)

library(ggVennDiagram)

ggVennDiagram(genes_list, label_alpha = 0) +
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme_void() +
    theme(
        plot.margin = margin(20, 40, 20, 40)  # extra space left/right
    ) +
    coord_cartesian(clip = "off")

```





#### UpsetPlot DOWNs

```{r}
# UpSet plot with three sets

upset_data <- list(
  top_DN_pval    = compare_genesets$top100_dn_p,
  top_DN_FC      = compare_genesets$top100_dn,
  all_sig_DN     = res_list$res_stim$Ser213_MUT_vs_WT %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
    mutate(
        direction = case_when(
            log2FoldChange >  1  ~ "UP",
            log2FoldChange < -1  ~ "DOWN"
        )) %>% filter(direction == "DOWN") %>% pull(gene),
  all_sig_UP     = res_list$res_stim$Ser213_MUT_vs_WT %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
    mutate(
        direction = case_when(
            log2FoldChange >  1  ~ "UP",
            log2FoldChange < -1  ~ "DOWN"
        )) %>% filter(direction == "UP") %>% pull(gene),
  Leaderboard_wald = compare_genesets$Leaderboard_up,
  refinded_set      = compare_genesets$refined,
  coulouarn_et_al   = compare_genesets$coulouarn,
  chen_et_al        = compare_genesets$chen
)

upset(
  fromList(upset_data),
  nsets = 8,
  order.by = "freq",
  sets.bar.color = c(#"steelblue", "firebrick", "forestgreen","orange","violet", 
                     #dput(get_colors()[1:8],
                         # c("#7FC97F", "#BEAED4", "#FDC086", "#386CB0", "#F0027F", "#1B9E77", "#D95F02", "#7570B3"),
#"#7FC97F", "#BEAED4", "#FDC086", "#386CB0", "#F0027F",
dput(get_colors()[1:8])

                     ))

```



#### UpsetPlot UPs

```{r}
# UpSet plot with three sets

upset_data <- list(
  top_UP_pval    = compare_genesets$top100_up_p,
  top_UP_FC      = compare_genesets$top100_up,
  all_sig_UP     = res_list$res_stim$Ser213_MUT_vs_WT %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
    mutate(
        direction = case_when(
            log2FoldChange >  1  ~ "UP",
            log2FoldChange < -1  ~ "DOWN"
        )) %>% filter(direction == "UP") %>% pull(gene),
  all_sig_DOWN     = res_list$res_stim$Ser213_MUT_vs_WT %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
    mutate(
        direction = case_when(
            log2FoldChange >  1  ~ "UP",
            log2FoldChange < -1  ~ "DOWN"
        )) %>% filter(direction == "DOWN") %>% pull(gene),
  Leaderboard_wald = compare_genesets$Leaderboard_dn,
  #refinded_set      = compare_genesets$refined,
  coulouarn_et_al   = compare_genesets$coulouarn,
  chen_et_al        = compare_genesets$chen
)

upset(
  fromList(upset_data),
  nsets = 8,
  order.by = "freq",
  sets.bar.color = c(#"steelblue", "firebrick", "forestgreen","orange","violet", 
                     #dput(get_colors()[1:8],
                         # c("#7FC97F", "#BEAED4", "#FDC086", "#386CB0", "#F0027F", "#1B9E77", "#D95F02", "#7570B3"),
#"#7FC97F", "#BEAED4", "#FDC086", "#386CB0", "#F0027F",
dput(get_colors()[1:7])

                     ))

```






# Session information

```{r}
sessionInfo()
```


